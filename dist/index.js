(function(o,d){typeof exports=="object"&&typeof module<"u"?d(exports):typeof define=="function"&&define.amd?define(["exports"],d):(o=typeof globalThis<"u"?globalThis:o||self,d(o.webcodec_player={}))})(this,function(o){"use strict";class d{constructor(t){this.config={codec:"hev1.1.6.L123.b0",codedWidth:640,codedHeight:480,hardwareAcceleration:"prefer-hardware"},this.isSupportedH265=!1,this.isDecodeFirstIIframe=!1,this.cnvCanvas=null,this.ctxCanvas=null,this.cnvVideo=null,this.cnvVideoTrackGenerator=null,this.ctxWriter=null,console.log(t);let i=t,e;if(typeof i.container=="string"?e=document.getElementById(i.container):e=i.container,!e)throw new Error("WebCodecPlayer need container option");if(e.nodeName==="CANVAS"||e.nodeName==="VIDEO")throw new Error(`WebCodecPlayer container type can not be ${e.nodeName} type`);this.cnvVideo=document.createElement("video"),this.cnvVideo.width=e.clientWidth,this.cnvVideo.height=e.clientHeight,this.cnvVideo.autoplay=!0,this.cnvVideo.muted=!0,e.firstChild&&e.removeChild(e.firstChild),e.appendChild(this.cnvVideo),this.cnvVideoTrackGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.cnvVideo.srcObject=new MediaStream([this.cnvVideoTrackGenerator]),this.ctxWriter=this.cnvVideoTrackGenerator.writable.getWriter(),this.decoder=null,this.isDecodeFirstIIframe=!1,this.isSupportedH265=!1,this.initDecoder()}destroy(){this.decoder&&(this.decoder.state!=="closed"&&this.decoder.close(),this.decoder=null),this.isDecodeFirstIIframe=!1,console.log("Webcodecs","destroy")}initDecoder(){const t=this;this.isSupportedHevc().then(function(i){console.log("is support h265",i),t.isSupportedH265=i.supported,t.isSupportedH265&&(t.decoder=new VideoDecoder({output(e){t.handleDecodeFrame(e)},error(e){console.log("Webcodecs","VideoDecoder handleError",e)}}),t.decoder.configure(t.config))}),console.log("-----init------")}decodeVideo(t,i,e){if(!this.isDecodeFirstIIframe&&e&&(this.isDecodeFirstIIframe=!0),this.isDecodeFirstIIframe){const c=new EncodedVideoChunk({timestamp:i,type:e?"key":"delta",data:t});try{this.decoder.decode(c)}catch(r){console.log("发生异常:"+r)}}}handleDecodeFrame(t){(this.config.codedWidth!==t.codedWidth||this.config.codedHeight!==t.codedHeight)&&(this.config.codedWidth=t.codedWidth,this.config.codedHeight=t.codedHeight,this.decoder.configure(this.config)),this.ctxWriter.write(t),t.close()}isSupportedHevc(){return VideoDecoder.isConfigSupported(this.config)}show(){console.log("hello world")}}window.GWebCodecPlayer=d,o.WebCodecPlayer=d,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})});
